# LMask
## Installation
We  recommend installing the environment from the file by running the following commands
```bash
conda create -n lmask python=3.10
conda activate lmask
pip install -r requirements.txt
```
- Main Python packages:
  * PyTorch = 2.5.1
  * RL4CO = 0.5.2
  * TensorDict = 0.6.2
  * pytorch-lightning = 2.5.0 
  * PyVRP = 0.11.0
  

## Quickstart
### Generate Datasets
The validation and test datasets can be generated by running the following command:
```bash
python generate_datasets.py
```
### Test
* Test a specific random dataset
```bash
python test.py --problem tsptw --problem_size 50 --hardness hard
```
If not provided, `test_path`, `checkpoint` and `ref_sol_path` will be automatically inferred from `problem`, `problem_size` and `hardness`. 
You can also provide additional parameters
```bash
usage: test.py [-h] [--seed SEED] [--batch_size BATCH_SIZE] [--problem {tspdl,tsptw}] [--problem_size {50,100}] [--hardness {easy,medium,hard}] 
               [--env_name ENV_NAME] [--policy_name POLICY_NAME] [--checkpoint CHECKPOINT] [--test_path TEST_PATH] [--ref_sol_path REF_SOL_PATH]
               [--look_ahead_step {1,2}] [--max_backtrack_steps MAX_BACKTRACK_STEPS] 
options:
  -h, --help            show this help message and exit
  --seed SEED
  --batch_size BATCH_SIZE
  --problem {tspdl,tsptw}
                        Problem type
  --problem_size {50,100}
                        Problem size
  --hardness {easy,medium,hard}
                        Problem difficulty
  --env_name ENV_NAME   Environment name
  --policy_name POLICY_NAME
                        Class name of the policy
  --checkpoint CHECKPOINT
                        Path to model checkpoint
  --test_path TEST_PATH
                        Path to test dataset
  --ref_sol_path REF_SOL_PATH
                        Path to reference solutions
  --look_ahead_step {1,2}
                        Number of lookahead steps when initializing the overestimation sets
  --max_backtrack_steps MAX_BACKTRACK_STEPS

```
* Test all datasets
```bash
python driver/test_all
```
The results will be saved to `results/main_results.csv`.

* Ablation study on the combination of backtracking and overestimation initialization strategies
```bash
python driver/bt_mask_comb.py
```
The results will be saved to `results/bt_mask_ablation.csv`.

### Training
```bash
python run.py experiment=main/tsptw/tsptw50-medium
```
You may change the experiment `experiment=main/tsptw/tsptw50-medium` by using the `experiment=YOUR_EXP`, with the path under [`configs/experiment`](configs/experiment) directory.

**Note**: After training, to use the checkpoints in test.py, you should first run the script `sripts/transform_checkpoints.py` to convert ckpt files to pth files.
